<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Juggle It!</title>
    <meta
      name="viewport"
      content="width=device-width, height=device-height,
    user-scalable=no, initial-scale=1, maximum-scale=1"
    />
    <script src="https://unpkg.com/sounds-some-sounds@3.1.0/build/index.js"></script>
    <script src="https://unpkg.com/gif-capture-canvas@1.1.0/build/index.js"></script>
    <script src="https://unpkg.com/pixi.js@5.3.0/dist/pixi.min.js"></script>
    <script src="https://unpkg.com/pixi-filters@3.1.1/dist/pixi-filters.js"></script>
    <script src="https://unpkg.com/crisp-game-lib@1.2.0/docs/bundle.js"></script>

    <script>
      title = "";

      description = `
            `;

      characters = [
        // Player Sprites
        `
 pppp
ppyLby
yyyyyy
rrrrr
ryyrr
ll ll
        `,
        `
 pppp
ppyLby
yyyyyy
rrrrr
rryyr
 llll
        `,
        // Personal Icon
        `
  ll
 lYYl
lYYYYl
YBYYYY
YBYLLY
YYYLLY
        `,
        // School Icon
        `
rrrrLr
rllrLr
rrrrLr
rllrLr
rrrrLr
LLLLLr
        `,
        // Work Icon
        `
 llll
 l  l
llllll
lLllLl
lLLLLl
llllll
        `,
        // Timer Icon
        `
 yyyy
yYlYYy
yYlYYy
yYllly
yYYYYy
 yyyy
        `,
        // Sanity Icon
        `
 pPPP
pPpPPP
PPPPpP
pPPpPp
PpPPP
 Pp
        `,
        // Education Icon
        `
  ll  
 llll 
lyllll
yllll 
y ll  
y     
        `,
        // Money Icon
        `

 gggg
gGGGGg
gGggGg
gGGGGg
 gggg
        `,
        /// Events

        // Car Breaks Down
        `
lbBBbl
lbbbbl
bbbbbb
bBBBBb
lBBBBl
lbbbbl
        `,
        // Lose Money Icon
        `

 rrrr
rRRRRr
rRrrRr
rRRRRr
 rrrr
        `,
        // Job Promotion
        `
 YYYY
 Y  Y
YYYYYY
YyYYyY
YyyyyY
YYYYYY
        `,
        // Fail a Test
        `
LLLLLL
LLLrrL
LLLrrL
LllllL
LLLLLL
LLLLLL
        `,
        // Pass a Test
        `
LLLLLL
LLLggL
LLLggL
LllllL
LLLLLL
LLLLLL
        `,
      ];

      options = {};

      /// Game State

      // player stats
      let playerY, playerVel, playerGrounded;
      let playerSprite,
        playerSpriteCount = 2;
      let sanity, education, money;

      // current game stage (0 = menu, 1 = select priority, 2 = running level)
      let stage;
      let timer, timerLength;

      // 11 seconds on selection menu
      const selectionTime = 11;

      // menu state
      let menuPage;

      // selection state
      let currentSelection;

      const personalCostMoney = 25;
      const schoolCostMoney = 50;
      const schoolCostSanity = 10;
      const workCostSanity = 20;

      // info state

      // running state
      let scrollSpeed;
      let objects, spawnTime, lastSpawnTime;

      // game over state

      // current priority (0 = personal/social life, 1 = education, 2 = work)
      let priority;

      /// Stage Implementations

      function menu() {
        if (input.isJustPressed) {
          menuPage += 1;

          if (menuPage == 2) {
            // transition to game stage
            stage = 1;

            timer = Date.now();
            timerLength = selectionTime * 1000;
          }
        }

        switch (menuPage) {
          case 0:
            text("Juggle It!", 23, 20);
            text("Press Start", 21, 50);
            break;
          case 1:
            text("Objective", 25, 20);
            text("Dont let sanity", 5, 40);
            text("or money goto 0!", 5, 47);
            text("Press to Start", 10, 70);
            break;
        }
      }

      function selection() {
        if (input.isJustPressed) {
          priority = (priority + 1) % 3;
        }

        // update timer
        let timeRemaining = timerLength - (Date.now() - timer);
        if (timeRemaining <= 0) {
          // transition to info stage
          stage = 2;

          switch (priority) {
            case 0: // personal
              money -= personalCostMoney;

              break;
            case 1: // school
              money -= schoolCostMoney;
              sanity -= schoolCostSanity;

              break;
            case 2: // work
              sanity -= workCostSanity;

              break;
          }

          return;
        }

        // show selection

        text("Pick a Priority", 10, 10);

        char("c", 30, 20);
        text("Personal", 40, 20, {
          color: priority == 0 ? "red" : "light_black",
        });

        char("d", 30, 30);
        text("School", 40, 30, {
          color: priority == 1 ? "red" : "light_black",
        });

        char("e", 30, 40);
        text("Work", 40, 40, { color: priority == 2 ? "red" : "light_black" });

        // show player current stats

        char("g", 30, 60);
        text("" + sanity, 37, 60);

        char("h", 30, 70);
        text("" + education, 37, 70);

        char("i", 30, 80);
        text("" + money, 37, 80);

        // show time remaining for choice

        char("f", 10, 95);
        text("" + floor(timeRemaining / 1000), 17, 95, {
          color: timeRemaining <= 4000 ? "red" : "black",
        });
      }

      function info() {
        if (input.isJustPressed) {
          // transition to running stage
          stage = 3;
          timer = Date.now();
          timerLength = rndi(25, 45) * 1000;
          scrollSpeed = 1;

          // setup objects
          objects = [];
          spawnTime = rnd(0.5, 3.5) * 1000;
          lastSpawnTime = 0;

          // setup player
          playerY = 90;
          playerVel = 0;
          playerGrounded = true;
          playerSprite = 0;
        }

        switch (priority) {
          case 0: // personal
            text("Personal", 30, 10);

            text("Collect", 25, 25, { color: "green" });
            char("g", 75, 25);

            text("Avoid", 40, 40, { color: "light_red" });
            char("j", 45, 50);
            char("k", 60, 50);

            text("Press to Start", 10, 70);

            break;
          case 1: // school
            text("School", 35, 10);

            text("Collect", 25, 25, { color: "green" });
            char("h", 75, 25);
            char("n", 85, 25);

            text("Avoid", 40, 40, { color: "light_red" });
            char("j", 45, 50);
            char("m", 60, 50);

            text("Press to Start", 10, 70);

            break;
          case 2: // work
            text("Work", 45, 10);

            text("Collect", 25, 25, { color: "green" });
            char("i", 75, 25);
            char("l", 85, 25);

            text("Avoid", 40, 40, { color: "light_red" });
            char("j", 52, 50);

            text("Press to Start", 10, 90);

            break;
        }
      }

      // TODO: Correlation between sanity, education, and money stats with spawn rates and movement speed
      // TODO: Objects (positive & negative events)

      function running() {
        // timer logic

        let timeRemaining = timerLength - (Date.now() - timer);
        if (timeRemaining <= 0) {
          // transition to selection stage
          stage = 1;
          timer = Date.now();
          timerLength = selectionTime * 1000;
          score += 1;
        }

        // game over logic
        if (sanity <= 0 || education <= 0 || money <= 0) {
          // transition to game over
          stage = 4;
          return;
        }

        // object logic
        let spawnTimeRemaining = spawnTime - (Date.now() - lastSpawnTime);
        if (spawnTimeRemaining <= 0) {
          // determine type
          let objectType = priority == 1 ? rndi(0, 4) : rndi(0, 3);

          // spawn object
          objects.push({
            ty: objectType,
            pos: vec(110, 90),
            vel: vec(-scrollSpeed, 0),
          });

          // update timer
          lastSpawnTime = Date.now();
          spawnTime = rnd(0.5, 4.5 - scrollSpeed) * 1000;
        }

        if (ticks % 10 == 0) {
          playerSprite = (playerSprite + 1) % playerSpriteCount;
        }

        // jumping input
        if (playerGrounded && input.isJustPressed) {
          playerGrounded = false;
          playerVel = 1.2;
        }

        if (playerVel != 0) {
          playerGrounded = false;
        }

        // gravity
        playerY -= playerVel;
        playerVel = playerVel - 0.05;

        // collision tests
        color("red");

        let playerCol = rect(10, playerY, 6, 6).isColliding;

        color("yellow");

        let floorCol = rect(0, 95, 200, 5).isColliding;

        if (floorCol.rect.red) {
          playerY = 90;
          playerVel = 0;
          playerGrounded = true;
        }

        color("blue");

        for (object of objects) {
          object.pos.x += object.vel.x;
          object.pos.y += object.vel.y;

          if (object.pos.x < -10) {
            objects.splice(objects.indexOf(object), 1);
            continue;
          }

          let objectCol = rect(object.pos.x, object.pos.y, 6, 6).isColliding;

          if (objectCol.rect.red) {
            objects.splice(objects.indexOf(object), 1);

            // player picks up object
            switch (priority) {
              case 0: // personal
                switch (object.ty) {
                  case 0: // Sanity
                    sanity += 5;
                    scrollSpeed += 0.5;

                    break;
                  case 1: // Car Breaks Down
                    sanity -= 30;
                    money -= 500;
                    scrollSpeed = 1;

                    break;
                  case 2: // Spend Money
                    money -= 20;
                    scrollSpeed = 1;

                    break;
                }
                break;
              case 1: // school
                switch (object.ty) {
                  case 0: // Education
                    education += 1;
                    scrollSpeed = 0.5;

                    break;
                  case 1: // Fail Test
                    money -= 100;
                    sanity -= 30;
                    education -= 10;
                    scrollSpeed = 1;

                    break;
                  case 2: // Pass Test
                    sanity += 5;
                    education += 5;
                    scrollSpeed += 1;

                    break;
                  case 3: // Car Breaks Down
                    money -= 500;
                    sanity -= 30;
                    scrollSpeed = 1;

                    break;
                }
                break;
              case 2: // work
                switch (object.ty) {
                  case 0: // Money
                    money += 10 + round(education / 10);
                    scrollSpeed += 0.5;

                    break;
                  case 1: // Job Promotion
                    money += 100;
                    sanity += 10;
                    scrollSpeed += 1;

                    break;
                  case 2: // Car Breaks Down
                    money -= 500;
                    sanity -= 30;
                    scrollSpeed = 1;

                    break;
                }
                break;
            }
          }
        }

        // clear screen (hacky, crisp-game-lib is a bit limiting)
        color("white");

        rect(0, 0, 100, 100);

        // reset color
        color("black");

        // show player sprite
        char(playerSprite == 0 ? "a" : "b", 13, playerY + 2);

        // show objects
        for (object of objects) {
          switch (priority) {
            case 0: // personal
              switch (object.ty) {
                case 0: // Sanity
                  char("g", object.pos.x + 3, object.pos.y + 2);
                  break;
                case 1: // Car Breaks Down
                  char("j", object.pos.x + 3, object.pos.y + 2);
                  break;
                case 2: // Spend Money
                  char("k", object.pos.x + 3, object.pos.y + 2);
                  break;
              }
              break;
            case 1: // school
              switch (object.ty) {
                case 0: // Education
                  char("h", object.pos.x + 3, object.pos.y + 2);
                  break;
                case 1: // Fail Test
                  char("m", object.pos.x + 3, object.pos.y + 2);
                  break;
                case 2: // Pass Test
                  char("n", object.pos.x + 3, object.pos.y + 2);
                  break;
                case 3: // Car Breaks Down
                  char("j", object.pos.x + 3, object.pos.y + 2);
                  break;
              }
              break;
            case 2: // work
              switch (object.ty) {
                case 0: // Money
                  char("i", object.pos.x + 3, object.pos.y + 2);
                  break;
                case 1: // Job Promotion
                  char("l", object.pos.x + 3, object.pos.y + 2);
                  break;
                case 2: // Car Breaks Down
                  char("j", object.pos.x + 3, object.pos.y + 2);
                  break;
              }
              break;
          }
        }

        // show floor
        switch (priority) {
          case 0:
            color("light_yellow");
            break;
          case 1:
            color("light_black");
            break;
          case 2:
            color("black");
            break;
        }

        rect(0, 95, 200, 5);

        // reset color
        color("black");

        // draw timer
        char("f", 5, 15);
        text("" + floor(timeRemaining / 1000), 12, 15, {
          color: timeRemaining <= 4000 ? "red" : "black",
        });
      }

      function gameOver() {
        if (input.isJustPressed) {
          // transition to menu
          stage = 0;
          sanity = 50;
          education = 10;
          money = 1000;
          stage = 0;
          menuPage = 0;
          currentSelection = 0;
          priority = 0;
          score = 0;
        }

        text("Game Over", 10, 10);

        text("Final Stats", 10, 30);

        char("g", 30, 60);
        text("" + sanity, 37, 60);

        char("h", 30, 70);
        text("" + education, 37, 70);

        char("i", 30, 80);
        text("" + money, 37, 80);
      }

      /// Main Loop

      function update() {
        if (!ticks) {
          // initialization

          sanity = 50;
          education = 10;
          money = 1000;
          stage = 0;
          menuPage = 0;
          currentSelection = 0;
          priority = 0;
        }

        switch (stage) {
          case 0: // menu
            menu();
            break;
          case 1: // selection
            selection();
            break;
          case 2: // level info
            info();
            break;
          case 3: // running
            running();
            break;
          case 4: // game over
            gameOver();
            break;
        }
      }

      window.addEventListener("load", onLoad);
    </script>
  </head>
  <body style="background: #ddd"></body>
</html>
