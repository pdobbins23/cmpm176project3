<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>crisp-game-lib</title>
    <meta
      name="viewport"
      content="width=device-width, height=device-height,
    user-scalable=no, initial-scale=1, maximum-scale=1"
    />
    <script src="https://unpkg.com/sounds-some-sounds@3.1.0/build/index.js"></script>
    <script src="https://unpkg.com/gif-capture-canvas@1.1.0/build/index.js"></script>
    <script src="https://unpkg.com/pixi.js@5.3.0/dist/pixi.min.js"></script>
    <script src="https://unpkg.com/pixi-filters@3.1.1/dist/pixi-filters.js"></script>
    <script src="https://unpkg.com/crisp-game-lib@1.2.0/docs/bundle.js"></script>

    <script>
      title = "";

      description = `
            `;

      characters = [
        // Player Sprite
        `
 pppp
ppyLby
yyyyyy
rrrrr
ryyrr
ll ll
        `,
        `
 pppp
ppyLby
yyyyyy
rrrrr
rryyr
 llll
        `,
        `
  ll
 lYYl
lYYYYl
YBYYYY
YBYLLY
YYYLLY
        `,
        `
rrrrLr
rllrLr
rrrrLr
rllrLr
rrrrLr
LLLLLr
        `,
        `
 llll
 l  l
llllll
lLllLl
lLLLLl
llllll
        `,
        `
 yyyy
yYlYYy
yYlYYy
yYllly
yYYYYy
 yyyy
        `,
        // Sanity Icon
        `
 pPPP
pPpPPP
PPPPpP
pPPpPp
PpPPP
 Pp
        `,
        // Education Icon
        `
  ll  
 llll 
lyllll
yllll 
y ll  
y     
        `,
        // Money Icon
        `

 gggg
gGGGGg
gGggGg
gGGGGg
 gggg
        `,
      ];

      options = {};

      /// Game State

      // player stats
      let playerY, playerVel, playerGrounded;
      let playerSprite,
        playerSpriteCount = 2;
      let sanity, education, money;

      // current game stage (0 = menu, 1 = select priority, 2 = running level)
      let stage;
      let timer, timeRemaining;

      // menu state
      let currentSelection;

      // selection state

      // running state

      // current priority (0 = personal/social life, 1 = education, 2 = work)
      let priority;

      /// Stage Implementations

      function menu() {}

      function selection() {
        if (input.isJustPressed) {
          priority = (priority + 1) % 3;
        }

        // update timer
        let timeRemaining = timerLength - (Date.now() - timer);
        if (timeRemaining <= 0) {
          // transition to running stage
          stage = 2;
          timer = Date.now();
          timeRemaining = rnd(8, 13) * 1000;

          // setup player
          playerY = 90;
          playerVel = 0;
          playerGrounded = true;
          playerSprite = 0;

          return;
        }

        // show selection

        text("Pick a Priority", 10, 10);

        char("c", 30, 20);
        text("Personal", 40, 20, {
          color: priority == 0 ? "red" : "light_black",
        });

        char("d", 30, 30);
        text("School", 40, 30, {
          color: priority == 1 ? "red" : "light_black",
        });

        char("e", 30, 40);
        text("Work", 40, 40, { color: priority == 2 ? "red" : "light_black" });

        // show player current stats

        char("g", 30, 60);
        text("" + sanity, 37, 60);

        char("h", 30, 70);
        text("" + education, 37, 70);

        char("i", 30, 80);
        text("" + money, 37, 80);

        // show time remaining for choice

        char("f", 10, 95);
        text("" + floor(timeRemaining / 1000), 17, 95, {
          color: timeRemaining <= 4000 ? "red" : "black",
        });
      }

      // TODO: Correlation between sanity, education, and money stats with spawn rates and movement speed
      // TODO: Objects (positive & negative events)

      function running() {
        if (ticks % 10 == 0) {
          playerSprite = (playerSprite + 1) % playerSpriteCount;
        }

        // jumping input
        if (playerGrounded && input.isJustPressed) {
          playerGrounded = false;
          playerVel = 1.2;
        }

        if (playerVel != 0) {
          playerGrounded = false;
        }

        // gravity
        playerY -= playerVel;
        playerVel = playerVel - 0.05;

        // collision tests
        color("red");

        let playerCol = rect(10, playerY, 6, 6).isColliding;
        let floorCol = rect(0, 95, 200, 5).isColliding;

        if (floorCol.rect.red) {
          playerY = 90;
          playerVel = 0;
          playerGrounded = true;
        }

        // clear screen (hacky, crisp-game-lib is a bit limiting)
        color("white");

        rect(0, 0, 100, 100);

        // reset color
        color("black");

        // show player sprite
        char(playerSprite == 0 ? "a" : "b", 13, playerY + 2);

        // show floor
        switch (priority) {
          case 0:
            color("light_yellow");
            break;
          case 1:
            color("light_black");
            break;
          case 2:
            color("black");
            break;
        }

        rect(0, 95, 200, 5);

        // reset color
        color("black");
      }

      /// Main Loop

      function update() {
        if (!ticks) {
          // initialization

          sanity = 50;
          education = 10;
          money = 1000;
          stage = 1;
          timer = Date.now();
          timerLength = 11 * 1000;
          currentSelection = 0;
          priority = 0;
        }

        switch (stage) {
          case 0: // menu
            menu();
            break;
          case 1: // selection
            selection();
            break;
          case 2: // running
            running();
            break;
        }
      }

      window.addEventListener("load", onLoad);
    </script>
  </head>
  <body style="background: #ddd"></body>
</html>
